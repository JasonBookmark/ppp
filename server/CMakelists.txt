cmake_minimum_required(VERSION 2.8.0)

set(MODULE_NAME server)
project(${MODULE_NAME} CXX)

set(EXE_NAME  ${MODULE_NAME})
set(LIB_NAME  ${MODULE_NAME}_lib)
set(TEST_NAME ${MODULE_NAME}_test)

message(STATUS "-------- CMake for module ${MODULE_NAME} --------")

set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/../webapp)
#----------------------------
# Third party dependencies
#----------------------------

# Boost Library
if (MSVC)
    set(Boost_USE_STATIC_LIBS ON)
    set(Boost_USE_STATIC_RUNTIME ON)
    set(Boost_MULTITHREADED ON)
    find_package(Boost COMPONENTS system date_time filesystem regex REQUIRED )
else()
    find_package(Boost COMPONENTS system thread REQUIRED )
endif()

set(MODULE_INC_DIRS
    "${CMAKE_CURRENT_SOURCE_DIR}/include"
     ${Boost_INCLUDE_DIRS}
)

set(MODULE_LIB_DEPS
    libppp
    ${OpenCV_LIBS}
    ${Boost_LIBRARIES}
    ${OPENCV_3RDPARTY_LIBS}
)

file(GLOB LIB_SRC_FILES "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp")
file(GLOB LIB_INC_FILES "${CMAKE_CURRENT_SOURCE_DIR}/include/*.h")

add_library(${LIB_NAME} ${LIB_SRC_FILES} ${LIB_INC_FILES})
link_directories(${MODULE_LIB_DIRS})
target_include_directories(${LIB_NAME} PUBLIC ${MODULE_INC_DIRS})
target_link_libraries(${LIB_NAME} ${MODULE_LIB_DEPS})

install(TARGETS ${LIB_NAME} DESTINATION ${CMAKE_INSTALL_PREFIX})
#--------------------------------
#  Executable
#--------------------------------
add_executable(${EXE_NAME} exe/main.cpp)
link_directories(${MODULE_LIB_DIRS})
target_include_directories(${EXE_NAME} PUBLIC ${MODULE_INC_DIRS})
target_link_libraries(${EXE_NAME} ${LIB_NAME} ${MODULE_LIB_DEPS})

install(TARGETS ${EXE_NAME} DESTINATION ${CMAKE_INSTALL_PREFIX})

#--------------------------------
#  Unit Tests
#--------------------------------
file(GLOB TEST_SRC_FILES "${CMAKE_CURRENT_SOURCE_DIR}/test/*.cpp")
file(GLOB TEST_INC_FILES "${CMAKE_CURRENT_SOURCE_DIR}/test/*.h")

set(TEST_INC_DIRS
        ${GMOCK_ROOT}/gtest/include
        ${GMOCK_ROOT}/include
        ${MODULE_INC_DIRS}
        )
set(TEST_LIB_DEPS
        ${MODULE_LIB_DEPS}
        ${LIB_NAME}
        gmock
        )

add_executable(${TEST_NAME} ${TEST_SRC_FILES} ${TEST_INC_FILES})
target_include_directories(${TEST_NAME} PUBLIC ${TEST_INC_DIRS})
target_link_libraries(${TEST_NAME} ${TEST_LIB_DEPS})

install(TARGETS ${TEST_NAME} DESTINATION ${CMAKE_INSTALL_PREFIX})